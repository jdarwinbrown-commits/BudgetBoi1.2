<!DOCTYPE html>
<html lang="en" class=""> <!-- 'dark' class will be added here -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BudgetBoi</title>
  
  <!-- 1. Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. App Styles -->
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    html.dark body { background-color: #111827; }
    html, body, #app-shell { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>

  <!-- App Shell -->
  <div id="app-shell" class="w-full max-w-md mx-auto bg-white flex flex-col overflow-hidden sm:my-6 sm:rounded-2xl sm:shadow-2xl dark:bg-gray-900 dark:border dark:border-gray-700">
    
    <!-- Loading/Auth Screen -->
    <div id="loading-screen" class="flex-grow flex flex-col items-center justify-center p-6 text-center">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">BudgetBoi</h1>
      <p class="text-gray-600 dark:text-gray-400">Connecting to shared budget...</p>
      <div class="mt-8 w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
    
    <!-- Main Content (starts hidden) -->
    <main class="flex-grow overflow-y-auto hide-scrollbar hidden">

      <!-- ======================= -->
      <!-- == DASHBOARD VIEW === -->
      <!-- ======================= -->
      <div id="view-dashboard" class="p-4 sm:p-6 space-y-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center">
          <button id="settings-btn" class="text-gray-500 dark:text-gray-400 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
            <svg data-lucide="settings" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .53 2.19l-.06.25a2 2 0 0 1-1.6 1.4l-.4.07a2 2 0 0 0-1.73 2.3l.03.26a2 2 0 0 0 1.6 1.73l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.53-2.19l.06-.25a2 2 0 0 1 1.6-1.4l.4-.07a2 2 0 0 0 1.73-2.3l-.03-.26a2 2 0 0 0-1.6-1.73l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
          <button id="dark-mode-toggle" class="text-gray-500 dark:text-gray-400 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
            <svg id="icon-sun" data-lucide="sun" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
            <svg id="icon-moon" data-lucide="moon" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
          </button>
        </div>
        <h1 class="text-4xl font-bold text-center text-gray-900 dark:text-white -mt-2">
          BudgetBoi
        </h1>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6">
          <h2 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Spent</h2>
          <p id="total-spent" class="mt-1 text-3xl font-semibold text-gray-900 dark:text-white">$0.00</p>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">By Person</h3>
          <div id="chart-person" class="space-y-3"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">By Category</h3>
          <div id="chart-category" class="space-y-3"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">By Month</h3>
          <div id="chart-month" class="space-y-3"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 sm:p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Expenses</h3>
            <button id="view-all-btn" class="text-sm font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300">
              View All
            </button>
          </div>
          <div id="recent-expenses-list" class="space-y-4"></div>
        </div>
      </div>
      
      <!-- === ADD/EDIT VIEW === -->
      <div id="view-add" class="p-4 sm:p-6 hidden">
        <div class="flex items-center mb-6">
          <button class="nav-back-btn text-gray-600 dark:text-gray-300 p-2 -ml-2 rounded-full">
            <svg data-lucide="arrow-left" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          </button>
          <h1 id="add-edit-title" class="text-xl font-semibold text-gray-900 dark:text-white ml-2">Add Expense</h1>
        </div>
        <form id="add-edit-form" class="space-y-6">
          <input type="hidden" id="editing-id">
          <div id="form-error" class="p-3 bg-red-100 border border-red-300 text-red-800 rounded-lg hidden"></div>
          <div>
            <label for="form-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <span class="text-gray-500 dark:text-gray-400 sm:text-sm">$</span>
              </div>
              <input type="number" id="form-amount" class="focus:ring-blue-500 focus:border-blue-500 block w-full pl-7 pr-12 sm:text-sm border-gray-300 rounded-lg py-3 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="0.00" step="0.01">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Person</label>
            <div id="form-person-container" class="mt-2 flex space-x-4"></div>
          </div>
          <div>
            <label for="form-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
            <select id="form-category" class="mt-1 block w-full py-3 px-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-white"></select>
          </div>
          <div>
            <label for="form-description" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description (Optional)</label>
            <input type="text" id="form-description" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-lg py-3 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="e.g., Coffee, Train ticket">
          </div>
          <div>
            <label for="form-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
            <input type="date" id="form-date" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-lg py-3 dark:bg-gray-800 dark:border-gray-600 dark:text-white">
          </div>
          <button type="submit" id="form-submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
            Save Expense
          </button>
        </form>
      </div>
      
      <!-- === FULL LIST VIEW ==== -->
      <div id="view-list" class="hidden">
        <div class="sticky top-0 z-10 bg-white dark:bg-gray-800 p-4 border-b border-gray-200 dark:border-gray-700 flex items-center">
          <button class="nav-back-btn text-gray-600 dark:text-gray-300 p-2 -ml-2 rounded-full">
            <svg data-lucide="arrow-left" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          </button>
          <h1 class="text-xl font-semibold text-gray-900 dark:text-white ml-2">All Expenses</h1>
        </div>
        <div id="full-expense-list-container" class="p-4 space-y-4"></div>
      </div>
      
      <!-- === SETTINGS VIEW ===== -->
      <div id="view-settings" class="p-4 sm:p-6 hidden">
        <div class="flex items-center mb-6">
          <button class="nav-back-btn text-gray-600 dark:text-gray-300 p-2 -ml-2 rounded-full">
            <svg data-lucide="arrow-left" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
          </button>
          <h1 class="text-xl font-semibold text-gray-900 dark:text-white ml-2">Manage Categories</h1>
        </div>
        <div id="category-error" class="p-3 mb-4 bg-red-100 border border-red-300 text-red-800 rounded-lg hidden"></div>
        <form id="add-category-form" class="flex space-x-2 mb-6">
          <input type="text" id="new-category-name" class="flex-grow block w-full shadow-sm sm:text-sm border-gray-300 rounded-lg py-3 dark:bg-gray-800 dark:border-gray-600 dark:text-white" placeholder="New category name">
          <button type="submit" class="py-3 px-4 rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
            Add
          </button>
        </form>
        <div id="category-list-container" class="space-y-2"></div>
      </div>

    </main>
    
    <!-- === BOTTOM NAV BAR (starts hidden) ==== -->
    <nav id="bottom-nav" class="flex-shrink-0 w-full flex justify-around items-center p-3 bg-white border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700 hidden">
      <button data-view="dashboard" class="nav-btn flex flex-col items-center justify-center w-24 text-blue-600 dark:text-blue-400">
        <svg data-lucide="layout-dashboard" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        <span class="text-xs mt-1">Dashboard</span>
      </button>
      <button data-view="add" class="nav-btn flex flex-col items-center justify-center text-gray-600 dark:text-gray-300 -mt-6" style="transform: translateY(-10px);">
        <div class="p-3 bg-white dark:bg-gray-800 rounded-full shadow-md">
          <svg data-lucide="plus-circle" width="32" height="32" class="text-blue-600" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
        </div>
        <span class="text-xs mt-1">Add</span>
      </button>
      <button data-view="list" class="nav-btn flex flex-col items-center justify-center w-24 text-gray-500 dark:text-gray-400">
        <svg data-lucide="list" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
        <span class="text-xs mt-1">Expenses</span>
      </button>
    </nav>

  </div> <!-- End #app-shell -->

  <!-- ======================= -->
  <!-- === MAIN APP SCRIPT === -->
  <!-- ======================= -->
  <script type="module">
    // 1. Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      collection, 
      onSnapshot, 
      addDoc, 
      setDoc, 
      deleteDoc, 
      query, 
      where, 
      getDocs, 
      writeBatch
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // 2. Import Lucide icons
    import lucide from "https://unpkg.com/lucide@latest/dist/esm/lucide.js";

    // 3. !!!!!!!!!!!!!!!!!! IMPORTANT !!!!!!!!!!!!!!!!!!
    // PASTE YOUR FIREBASE CONFIG OBJECT FROM STEP 1 HERE
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    const firebaseConfig = {
      // apiKey: "AIza...",
      // authDomain: "YOUR-PROJECT.firebaseapp.com",
      // projectId: "YOUR-PROJECT",
      // ...
    };

    // --- LOCALSTORAGE KEYS ---
    const DARK_MODE_KEY = 'budgetBoiDarkMode';

    // --- INITIAL STATE (Defaults) ---
    const defaultCategories = ['Food', 'Transport', 'Utilities', 'Entertainment', 'Shopping', 'Other'];
    const defaultPeople = ['Jarod', 'Tiana'];
    const defaultExpenses = [
      { amount: 75.50, category: 'Food', description: 'Groceries', date: '2025-10-01', person: 'Tiana' },
      { amount: 30.00, category: 'Transport', description: 'Bus pass', date: '2025-10-03', person: 'Jarod' },
    ];
    
    // --- APP-WIDE STATE ---
    let state = {
      currentView: 'dashboard',
      people: defaultPeople,
      expenses: [], // Will be filled by Firestore
      categories: [], // Will be filled by Firestore
      editingExpenseId: null,
    };
    
    // --- FIREBASE REFERENCES ---
    let db, auth;
    let expensesCol, categoriesCol;

    // --- DOM ELEMENTS ---
    const loadingScreen = document.getElementById('loading-screen');
    const mainContent = document.querySelector('main');
    const bottomNav = document.getElementById('bottom-nav');
    const navButtons = document.querySelectorAll('.nav-btn');
    const backButtons = document.querySelectorAll('.nav-back-btn');
    
    const views = {
      dashboard: document.getElementById('view-dashboard'),
      add: document.getElementById('view-add'),
      list: document.getElementById('view-list'),
      settings: document.getElementById('view-settings'),
    };
    
    const settingsBtn = document.getElementById('settings-btn');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    const totalSpentEl = document.getElementById('total-spent');
    const chartPerson = document.getElementById('chart-person');
    const chartCategory = document.getElementById('chart-category');
    const chartMonth = document.getElementById('chart-month');
    const recentExpensesList = document.getElementById('recent-expenses-list');
    const viewAllBtn = document.getElementById('view-all-btn');

    const addEditForm = document.getElementById('add-edit-form');
    const addEditTitle = document.getElementById('add-edit-title');
    const editingIdEl = document.getElementById('editing-id');
    const formErrorEl = document.getElementById('form-error');
    const formAmountEl = document.getElementById('form-amount');
    const formPersonContainer = document.getElementById('form-person-container');
    const formCategoryEl = document.getElementById('form-category');
    const formDescriptionEl = document.getElementById('form-description');
    const formDateEl = document.getElementById('form-date');
    const formSubmitBtn = document.getElementById('form-submit-btn');

    const fullExpenseListContainer = document.getElementById('full-expense-list-container');
    
    const categoryErrorEl = document.getElementById('category-error');
    const addCategoryForm = document.getElementById('add-category-form');
    const newCategoryNameEl = document.getElementById('new-category-name');
    const categoryListContainer = document.getElementById('category-list-container');

    // --- HELPER FUNCTIONS ---
    const formatCurrency = (num) => `$${num.toFixed(2)}`;
    const formatDate = (dateString) => new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC',
    });
    const getCategoryIcon = (category) => {
      switch (category) {
        case 'Food': return 'ðŸ”';
        case 'Transport': return 'ðŸš—';
        case 'Utilities': return 'ðŸ’¡';
        case 'Entertainment': return 'ðŸŽ¬';
        case 'Shopping': return 'ðŸ›ï¸';
        default: return 'ðŸ’¸';
      }
    };

    /**
     * Main navigation function.
     */
    function navigateTo(viewName) {
      state.currentView = viewName;
      Object.values(views).forEach(view => view.classList.add('hidden'));
      if (views[viewName]) {
        views[viewName].classList.remove('hidden');
      } else {
        views.dashboard.classList.remove('hidden');
      }
      
      if (viewName === 'add' || viewName === 'settings') {
        bottomNav.classList.add('hidden');
      } else {
        bottomNav.classList.remove('hidden');
      }
      
      navButtons.forEach(btn => {
        const btnView = btn.dataset.view;
        if (btnView === viewName) {
          btn.classList.remove('text-gray-500', 'dark:text-gray-400');
          btn.classList.add('text-blue-600', 'dark:text-blue-400');
        } else if (btnView !== 'add') {
          btn.classList.add('text-gray-500', 'dark:text-gray-400');
          btn.classList.remove('text-blue-600', 'dark:text-blue-400');
        }
      });
      
      if (viewName === 'dashboard') renderDashboard();
      if (viewName === 'list') renderFullExpenseList();
      if (viewName === 'settings') renderCategoryList();
    }

    // --- DATA FUNCTIONS ---
    function getDashboardData() {
      const expenses = state.expenses;
      const totalSpent = expenses.reduce((acc, exp) => acc + exp.amount, 0);

      const personMap = new Map();
      state.people.forEach(p => personMap.set(p, 0));
      expenses.forEach(exp => {
        personMap.set(exp.person, (personMap.get(exp.person) || 0) + exp.amount);
      });
      const personData = Array.from(personMap.entries())
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);

      const categoryMap = new Map();
      state.categories.forEach(c => categoryMap.set(c, 0));
      expenses.forEach(exp => {
        categoryMap.set(exp.category, (categoryMap.get(exp.category) || 0) + exp.amount);
      });
      const categoryData = Array.from(categoryMap.entries())
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => b.value - a.value);

      const monthMap = new Map();
      expenses.forEach(exp => {
        const month = new Date(exp.date).toLocaleString('default', { month: 'short', year: '2-digit', timeZone: 'UTC' });
        monthMap.set(month, (monthMap.get(month) || 0) + exp.amount);
      });
      const monthData = Array.from(monthMap.entries())
        .map(([name, value]) => ({ name, value }))
        .sort((a, b) => new Date(a.name) - new Date(b.name));
        
      const recentExpenses = [...expenses]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);

      return { totalSpent, personData, categoryData, monthData, recentExpenses };
    }
    
    function getGroupedExpenses() {
      const sortedExpenses = [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
      return sortedExpenses.reduce((acc, exp) => {
        const date = formatDate(exp.date);
        if (!acc[date]) acc[date] = [];
        acc[date].push(exp);
        return acc;
      }, {});
    }

    // --- RENDER FUNCTIONS ---
    
    function renderBarChart(container, data) {
      container.innerHTML = '';
      const maxValue = Math.max(...data.map(d => d.value));
      if (data.length === 0 || maxValue === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-10">No spending data to display.</p>';
        return;
      }
      data.forEach(item => {
        if (item.value <= 0) return;
        const percent = (item.value / maxValue) * 100;
        container.insertAdjacentHTML('beforeend', `
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${item.name}</span>
              <span class="text-sm font-semibold text-gray-900 dark:text-white">${formatCurrency(item.value)}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percent}%"></div>
            </div>
          </div>
        `);
      });
    }
    
    function renderDashboard() {
      const data = getDashboardData();
      totalSpentEl.textContent = formatCurrency(data.totalSpent);
      renderBarChart(chartPerson, data.personData);
      renderBarChart(chartCategory, data.categoryData);
      renderBarChart(chartMonth, data.monthData);
      
      recentExpensesList.innerHTML = '';
      if (data.recentExpenses.length === 0) {
        recentExpensesList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-10">No expenses logged yet.</p>';
      } else {
        data.recentExpenses.forEach(exp => {
          recentExpensesList.insertAdjacentHTML('beforeend', renderExpenseItem(exp, false));
        });
      }
      lucide.createIcons();
    }
    
    function renderFullExpenseList() {
      const groupedExpenses = getGroupedExpenses();
      fullExpenseListContainer.innerHTML = '';
      if (Object.keys(groupedExpenses).length === 0) {
        fullExpenseListContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-20">No expenses logged yet.</p>';
        return;
      }
      for (const date in groupedExpenses) {
        let dateGroupHtml = `
          <div>
            <h2 class="text-sm font-semibold text-gray-600 dark:text-gray-400 px-2 my-2">${date}</h2>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
        `;
        groupedExpenses[date].forEach((exp, index) => {
          dateGroupHtml += renderExpenseItem(exp, true, index === groupedExpenses[date].length - 1);
        });
        dateGroupHtml += '</div></div>';
        fullExpenseListContainer.insertAdjacentHTML('beforeend', dateGroupHtml);
      }
      lucide.createIcons();
    }
    
    function renderExpenseItem(expense, showMenu, isLast = false) {
      return `
        <div class="flex items-center p-4 ${isLast ? '' : 'border-b border-gray-100 dark:border-gray-700'}">
          <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center">
            <span class="text-lg">${getCategoryIcon(expense.category)}</span>
          </div>
          <div class="ml-4 flex-grow">
            <p class="text-sm font-medium text-gray-900 dark:text-white">${expense.description || expense.category}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">${expense.category} &bull; ${expense.person}</p>
          </div>
          <div class="text-right">
            <p class="text-sm font-semibold text-gray-900 dark:text-white">-${formatCurrency(expense.amount)}</p>
          </div>
          ${showMenu ? `
          <div class="ml-2">
            <button data-id="${expense.id}" class="edit-btn p-1 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
              <svg data-lucide="edit-2" width="18" height="18"><use href="https://unpkg.com/lucide@latest/dist/sprite.svg#edit-2"></use></svg>
            </button>
            <button data-id="${expense.id}" class="delete-btn p-1 rounded-full text-red-500 hover:bg-red-100 dark:hover:bg-gray-700">
              <svg data-lucide="trash-2" width="18" height="18"><use href="https://unpkg.com/lucide@latest/dist/sprite.svg#trash-2"></use></svg>
            </button>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    function renderForm(expenseToEdit = null) {
      state.editingExpenseId = expenseToEdit ? expenseToEdit.id : null;
      formErrorEl.classList.add('hidden');
      
      formPersonContainer.innerHTML = '';
      state.people.forEach(person => {
        const checked = (expenseToEdit ? expenseToEdit.person : state.people[0]) === person;
        formPersonContainer.insertAdjacentHTML('beforeend', `
          <label class="flex items-center">
            <input type="radio" name="person" value="${person}" ${checked ? 'checked' : ''} class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 dark:bg-gray-700">
            <span class="ml-2 text-sm text-gray-900 dark:text-gray-200">${person}</span>
          </label>
        `);
      });
      
      formCategoryEl.innerHTML = '';
      state.categories.forEach(cat => {
        const selected = (expenseToEdit && expenseToEdit.category === cat);
        formCategoryEl.insertAdjacentHTML('beforeend', `<option value="${cat}" ${selected ? 'selected' : ''}>${cat}</option>`);
      });
      
      if (expenseToEdit) {
        addEditTitle.textContent = 'Edit Expense';
        formSubmitBtn.textContent = 'Update Expense';
        editingIdEl.value = expenseToEdit.id;
        formAmountEl.value = expenseToEdit.amount;
        formDescriptionEl.value = expenseToEdit.description;
        formDateEl.value = expenseToEdit.date;
      } else {
        addEditTitle.textContent = 'Add Expense';
        formSubmitBtn.textContent = 'Save Expense';
        addEditForm.reset();
        editingIdEl.value = '';
        formDateEl.value = new Date().toISOString().split('T')[0];
      }
    }
    
    function renderCategoryList() {
      categoryListContainer.innerHTML = '';
      categoryErrorEl.classList.add('hidden');
      state.categories.forEach(cat => {
        const isOther = cat === 'Other';
        categoryListContainer.insertAdjacentHTML('beforeend', `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm flex items-center justify-between">
            <p class="text-gray-900 dark:text-white">${cat}</p>
            ${!isOther ? `
            <div class="space-x-1">
              <button data-name="${cat}" class="delete-category-btn p-2 text-red-500 hover:bg-red-100 dark:hover:bg-gray-700 rounded-full">
                <svg data-lucide="trash-2" width="18" height="18"><use href="https://unpkg.com/lucide@latest/dist/sprite.svg#trash-2"></use></svg>
              </button>
            </div>
            ` : ''}
          </div>
        `);
      });
      lucide.createIcons();
    }
    
    // --- Dark Mode Handler (uses localStorage) ---
    function setDarkMode(isDark) {
      if (isDark) {
        document.documentElement.classList.add('dark');
        iconSun.classList.remove('hidden');
        iconMoon.classList.add('hidden');
      } else {
        document.documentElement.classList.remove('dark');
        iconSun.classList.add('hidden');
        iconMoon.classList.remove('hidden');
      }
      localStorage.setItem(DARK_MODE_KEY, isDark);
      if(state.currentView === 'dashboard') renderDashboard();
    }

    // --- EVENT HANDLERS (Firestore versions) ---
    
    // Add/Edit Form Submit
    addEditForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const amount = parseFloat(formAmountEl.value);
      const date = formDateEl.value;
      if (!amount || amount <= 0) {
        formErrorEl.textContent = 'Please enter a valid amount.';
        formErrorEl.classList.remove('hidden');
        return;
      }
      if (!date) {
        formErrorEl.textContent = 'Please select a date.';
        formErrorEl.classList.remove('hidden');
        return;
      }
      
      const expenseData = {
        amount: amount,
        person: document.querySelector('input[name="person"]:checked').value,
        category: formCategoryEl.value,
        description: formDescriptionEl.value.trim(),
        date: date,
      };
      
      try {
        formSubmitBtn.disabled = true;
        formSubmitBtn.textContent = 'Saving...';
        if (state.editingExpenseId) {
          const docRef = doc(db, expensesCol.path, state.editingExpenseId);
          await setDoc(docRef, expenseData);
        } else {
          await addDoc(expensesCol, expenseData);
        }
        state.editingExpenseId = null;
        addEditForm.reset();
        navigateTo('dashboard');
      } catch (err) {
        console.error("Error saving expense: ", err);
        formErrorEl.textContent = 'Error saving expense. Please try again.';
        formErrorEl.classList.remove('hidden');
      } finally {
        formSubmitBtn.disabled = false;
        renderForm(null); // Resets button text
      }
    });
    
    // Expense List Edit/Delete
    fullExpenseListContainer.addEventListener('click', async (e) => {
      const deleteBtn = e.target.closest('.delete-btn');
      const editBtn = e.target.closest('.edit-btn');
      
      if (deleteBtn) {
        const id = deleteBtn.dataset.id;
        if (confirm('Are you sure you want to delete this expense?')) {
          try {
            await deleteDoc(doc(db, expensesCol.path, id));
            // onSnapshot will handle the re-render
          } catch (err) {
            console.error("Error deleting expense: ", err);
            alert("Error deleting expense.");
          }
        }
      }
      
      if (editBtn) {
        const id = editBtn.dataset.id;
        const expenseToEdit = state.expenses.find(exp => exp.id === id);
        if (expenseToEdit) {
          renderForm(expenseToEdit);
          navigateTo('add');
        }
      }
    });
    
    // Add Category
    addCategoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newName = newCategoryNameEl.value.trim();
      
      if (newName === '') {
        categoryErrorEl.textContent = 'Category name cannot be empty.';
        categoryErrorEl.classList.remove('hidden');
        return;
      }
      const exists = state.categories.find(cat => cat.toLowerCase() === newName.toLowerCase());
      if (exists) {
        categoryErrorEl.textContent = 'Category already exists.';
        categoryErrorEl.classList.remove('hidden');
        return;
      }
      
      try {
        await addDoc(categoriesCol, { name: newName });
        newCategoryNameEl.value = '';
        categoryErrorEl.classList.add('hidden');
      } catch (err) {
        console.error("Error adding category: ", err);
        categoryErrorEl.textContent = 'Error adding category.';
        categoryErrorEl.classList.remove('hidden');
      }
    });
    
    // Delete Category
    categoryListContainer.addEventListener('click', async (e) => {
      const deleteBtn = e.target.closest('.delete-category-btn');
      if (deleteBtn) {
        const name = deleteBtn.dataset.name;
        if (confirm(`Are you sure you want to delete "${name}"? All expenses in this category will be moved to "Other".`)) {
          try {
            const catQuery = query(categoriesCol, where("name", "==", name));
            const catSnapshot = await getDocs(catQuery);
            if (catSnapshot.empty) throw new Error("Category not found");
            const catDoc = catSnapshot.docs[0];

            const expQuery = query(expensesCol, where("category", "==", name));
            const expSnapshot = await getDocs(expQuery);
            
            const batch = writeBatch(db);
            expSnapshot.forEach(expDoc => {
              batch.update(expDoc.ref, { category: "Other" });
            });
            batch.delete(catDoc.ref);
            await batch.commit();
            // onSnapshot will handle the UI update
          } catch (err) {
            console.error("Error deleting category: ", err);
            alert("Error deleting category.");
          }
        }
      }
    });
    
    // --- INITIALIZATION ---
    
    async function seedDatabase() {
      console.log("Seeding database with default data...");
      const batch = writeBatch(db);
      defaultCategories.forEach(catName => {
        const catRef = doc(collection(db, categoriesCol.path));
        batch.set(catRef, { name: catName });
      });
      defaultExpenses.forEach(exp => {
        const expRef = doc(collection(db, expensesCol.path));
        batch.set(expRef, exp);
      });
      await batch.commit();
    }
    
    async function initializeApp() {
      // Check if firebaseConfig is placeholder
      if (!firebaseConfig.apiKey) {
        loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Error: Firebase config is missing.</p><p class="text-gray-600 dark:text-gray-400 mt-2">Please edit index.html and paste your firebaseConfig object.</p>`;
        return;
      }

      try {
        // 1. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // 2. Sign in (anonymously)
        await signInAnonymously(auth);

        // 3. Set up database paths (simplified)
        expensesCol = collection(db, 'budgetboi/expenses');
        categoriesCol = collection(db, 'budgetboi/categories');

        // 4. Start real-time listeners
        onSnapshot(expensesCol, (snapshot) => {
          state.expenses = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          if (state.currentView === 'dashboard') renderDashboard();
          if (state.currentView === 'list') renderFullExpenseList();
        });

        onSnapshot(categoriesCol, (snapshot) => {
          if (snapshot.empty) {
            seedDatabase();
            return; 
          }
          state.categories = snapshot.docs
            .map(doc => doc.data().name)
            .sort((a, b) => a === 'Other' ? 1 : b === 'Other' ? -1 : a.localeCompare(b));
          
          if (state.currentView === 'settings') renderCategoryList();
          if (state.currentView === 'add') renderForm(state.editingExpenseId ? state.expenses.find(e => e.id === state.editingExpenseId) : null);
          if (state.currentView === 'dashboard') renderDashboard();
        });

        // 5. Show the app
        loadingScreen.classList.add('hidden');
        mainContent.classList.remove('hidden');
        bottomNav.classList.remove('hidden');
        navigateTo('dashboard');
            
      } catch (err) {
        console.error("Firebase Initialization Error:", err);
        loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Error connecting to Firebase.</p><p class="text-gray-600 dark:text-gray-400 mt-2">1. Did you paste your firebaseConfig?<br>2. Did you authorize your domain in Firebase Authentication?</p>`;
      }
      
      // 6. Load Dark Mode from localStorage
      const prefersDark = localStorage.getItem(DARK_MODE_KEY) === 'true' || 
        (localStorage.getItem(DARK_MODE_KEY) === null && window.matchMedia('(prefers-color-scheme: dark)').matches);
      setDarkMode(prefersDark);
      
      // 7. Add other event listeners
      navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const viewName = btn.dataset.view;
          if (viewName === 'add') {
            renderForm(null);
          }
          navigateTo(viewName);
        });
      });
      backButtons.forEach(btn => btn.addEventListener('click', () => navigateTo('dashboard')));
      viewAllBtn.addEventListener('click', () => navigateTo('list'));
      settingsBtn.addEventListener('click', () => navigateTo('settings'));
      darkModeToggle.addEventListener('click', () => {
        const isCurrentlyDark = document.documentElement.classList.contains('dark');
        setDarkMode(!isCurrentlyDark);
      });
      
      // 8. Create all icons
      lucide.createIcons();
    }
    
    // Start the app!
    initializeApp();

  </script>
  
</body>
</html>


